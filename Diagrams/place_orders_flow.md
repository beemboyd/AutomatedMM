# Order Placement Process Flow

## place_orders.py Flow Chart

```mermaid
flowchart TD
    Start([Start]) --> Init[Initialize System]
    Init --> LoadConfig[Load Configuration]
    LoadConfig --> CheckArgs[Check Command Line Arguments]
    CheckArgs --> GetSignalFiles[Get Latest Signal Files]
    GetSignalFiles --> ReadLongSignals[Read Long Signal File]
    ReadLongSignals --> ReadShortSignals[Read Short Signal File]
    
    ReadLongSignals --> AnalyzeMarketBreadth[Analyze Market Breadth]
    AnalyzeMarketBreadth -- Bearish --> DisableLong[Disable Long Orders]
    AnalyzeMarketBreadth -- Bullish --> DisableShort[Disable Short Orders]
    AnalyzeMarketBreadth -- Neutral --> AllowBoth[Allow Both Order Types]
    
    DisableLong --> ProcessShort[Process Short Orders]
    DisableShort --> ProcessLong[Process Long Orders]
    AllowBoth --> ProcessLong
    AllowBoth --> ProcessShort
    
    subgraph "Long Orders Processing"
        ProcessLong --> GetCurrentLongs[Get Current Long Positions]
        GetCurrentLongs --> SelectTopLong[Select Top N Long Opportunities]
        SelectTopLong --> FilterLong[Filter Out Existing Positions]
        FilterLong --> PlaceLongOrders[Place New LONG Orders]
    end
    
    subgraph "Short Orders Processing"
        ProcessShort --> GetCurrentShorts[Get Current Short Positions]
        GetCurrentShorts --> SelectTopShort[Select Top N Short Opportunities]
        SelectTopShort --> FilterShort[Filter Out Existing Positions]
        FilterShort --> PlaceShortOrders[Place New SHORT Orders]
    end
    
    PlaceLongOrders --> UpdateLongState[Update Long Position State]
    PlaceShortOrders --> UpdateShortState[Update Short Position State]
    
    UpdateLongState --> LogSummary[Log Order Placement Summary]
    UpdateShortState --> LogSummary
    LogSummary --> End([End])
    
    classDef process fill:#f9f,stroke:#333,stroke-width:1px;
    classDef decision fill:#ff9,stroke:#333,stroke-width:1px;
    classDef data fill:#bfb,stroke:#333,stroke-width:1px;
    classDef start fill:#bbf,stroke:#333,stroke-width:2px;
    classDef end fill:#fbb,stroke:#333,stroke-width:2px;
    
    class ReadLongSignals,ReadShortSignals,PlaceLongOrders,PlaceShortOrders process;
    class AnalyzeMarketBreadth decision;
    class GetSignalFiles,GetCurrentLongs,GetCurrentShorts data;
    class Start,End start;
```

## Key Logic Steps in place_orders.py

1. **Signal File Processing**:
   - Locates and reads the latest signal files generated by scan_market.py
   - Parses the market breadth information from the Summary sheet
   - Extracts ticker symbols and position size information

2. **Market Breadth Analysis**:
   - Calculates Advances/Declines ratio from the signal files
   - If ratio ≥ trend_ratio_threshold (default 4.0): Disables SHORT orders (bullish market)
   - If ratio ≤ 1/trend_ratio_threshold (default 0.25): Disables LONG orders (bearish market)
   - If between thresholds: Allows both LONG and SHORT orders (neutral market)

3. **New Order Selection**:
   - Selects top N opportunities based on max_positions config
   - Filters out tickers that already have positions
   - Filters out tickers with pending orders
   - Does not place orders for tickers traded within the last hour

4. **Order Placement**:
   - Places market orders for new positions via Zerodha API
   - Records order confirmations and entry prices
   - Updates state manager with new position information
   - Updates daily traded ticker list to prevent duplicate trades

5. **Important Changes as of 2025-05-07**:
   - **NO LONGER closes positions** when tickers drop out of signal files
   - Position closing is now exclusively handled by:
     - position_watchdog.py (based on stop loss conditions)
     - End-of-day closure from Zerodha (for MIS positions)

## Post-Order Processing

- Updates trading state with new positions
- Logs order placement summary
- Records position details for monitoring by position_watchdog.py

## Execution Schedule

- Runs every 10 minutes via launchd job
- Also scheduled to run at 9:15 AM on weekdays
- Respects a 1-hour cooldown period between orders for the same ticker