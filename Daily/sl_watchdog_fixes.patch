#!/bin/bash
# This script applies all the SL_watchdog fixes

cat << 'EOF' > /tmp/sl_watchdog_changes.py
# Changes to SL_watchdog.py

# 1. Update setup_logging to use RotatingFileHandler
def setup_logging(user_name: str):
    """Set up logging with user-specific log files and rotation"""
    from logging.handlers import RotatingFileHandler
    
    # Create user-specific log directory
    log_dir = os.path.join(os.path.dirname(os.path.dirname(os.path.abspath(__file__))), 'logs', user_name)
    os.makedirs(log_dir, exist_ok=True)
    
    log_file = os.path.join(log_dir, f'SL_watchdog_{user_name}.log')
    
    # Configure logging with rotation
    log_format = '%(asctime)s - %(levelname)s - %(message)s'
    
    # Create logger
    logger = logging.getLogger()
    logger.setLevel(logging.INFO)
    logger.handlers = []  # Clear existing handlers
    
    # Create rotating file handler (10MB per file, keep 5 backups)
    file_handler = RotatingFileHandler(
        log_file,
        maxBytes=10*1024*1024,  # 10MB
        backupCount=5,
        encoding='utf-8'
    )
    file_handler.setFormatter(logging.Formatter(log_format))
    logger.addHandler(file_handler)
    
    # Console handler
    console_handler = logging.StreamHandler()
    console_handler.setFormatter(logging.Formatter(log_format))
    logger.addHandler(console_handler)
    
    logger.info(f"Logging initialized for user {user_name} with rotation (10MB max, 5 backups)")
    
    return logger

# 2. Add cache for instruments data
# In __init__ method after self.data_handler = get_user_data_handler()
        # Cache for instruments data
        self.instruments_cache = None
        self.instruments_last_fetch = 0

# 3. Add sma20_hourly_data tracking
# In __init__ method after self.atr_data = {}
        self.sma20_hourly_data = {}  # ticker -> {'sma20_violations': count, 'hours_monitored': count, 'hours_above_sma20': count}

# 4. Update tick size handling
        # Tick size mapping (default fallback for unknown tickers)
        self.default_tick_size = 0.05
        self.tick_sizes = {}  # Will be populated dynamically from instruments data
        
        # Known tick sizes for specific tickers that often cause issues
        self.known_tick_sizes = {
            "AIAENG": 0.10,
            "CREDITACC": 0.10,
            # Add more as needed
        }
        
        # Common tick sizes based on price ranges (NSE guidelines)
        # These are fallbacks when instrument data is not available
        self.price_tick_ranges = [
            (0, 50, 0.01),      # Below ₹50: tick size 0.01
            (50, 100, 0.05),    # ₹50-100: tick size 0.05
            (100, 500, 0.05),   # ₹100-500: tick size 0.05
            (500, 1000, 0.10),  # ₹500-1000: tick size 0.10
            (1000, 5000, 0.25), # ₹1000-5000: tick size 0.25
            (5000, 10000, 0.50),# ₹5000-10000: tick size 0.50
            (10000, float('inf'), 1.00) # Above ₹10000: tick size 1.00
        ]

# 5. Update monitoring state variables
        # Monitoring state
        self.running = False
        self.last_price_check = 0
        self.last_atr_check = 0
        self.last_sma20_check = 0
        self.last_position_sync = 0

# 6. Add SMA20 logging
        self.logger.info("")
        self.logger.info("SMA20 HOURLY EXIT RULES ENABLED (Brooks Strategy)")
        self.logger.info("- Exit if hourly close below SMA20 >= 2 times")
        self.logger.info("- Exit if hours above SMA20 < 80% of total hours")
        self.logger.info("- Based on statistical analysis showing 27.5% win rate for violators")
        self.logger.info("=" * 60)
EOF

echo "Patch file created. Apply manually to SL_watchdog.py"