<!-- Confluence Widget for VSR Dashboard -->
<!-- This can be included in the existing vsr_tracker_dashboard.html -->

<style>
.confluence-section {
    background-color: #1a1a1a;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    border: 1px solid #333;
}

.confluence-header {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
    font-size: 18px;
    font-weight: bold;
}

.confluence-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 10px;
}

.confluence-ticker {
    background-color: #2a2a2a;
    border-radius: 6px;
    padding: 12px;
    border: 1px solid #444;
    transition: all 0.3s ease;
}

.confluence-ticker:hover {
    border-color: #4CAF50;
    box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
}

.confluence-ticker-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.ticker-symbol {
    font-size: 16px;
    font-weight: bold;
    color: #4CAF50;
}

.confluence-score {
    background-color: #4CAF50;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
}

.confluence-score.high {
    background-color: #4CAF50;
}

.confluence-score.medium {
    background-color: #FFA726;
}

.confluence-score.low {
    background-color: #42A5F5;
}

.ticker-metrics {
    display: flex;
    justify-content: space-between;
    font-size: 14px;
    color: #ccc;
    margin-bottom: 6px;
}

.momentum-bar {
    height: 4px;
    background-color: #333;
    border-radius: 2px;
    margin-top: 8px;
    overflow: hidden;
}

.momentum-fill {
    height: 100%;
    background: linear-gradient(90deg, #4CAF50, #8BC34A);
    transition: width 0.3s ease;
}

.signal-badge {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: bold;
}

.signal-strong {
    background-color: #4CAF50;
    color: white;
}

.signal-medium {
    background-color: #FFA726;
    color: white;
}

.signal-weak {
    background-color: #9E9E9E;
    color: white;
}

.emerging-ticker {
    border-left: 3px solid #FF5722;
}

.alert-banner {
    background-color: #FF5722;
    color: white;
    padding: 10px 15px;
    border-radius: 6px;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 0.8; }
    50% { opacity: 1; }
    100% { opacity: 0.8; }
}

.timeframe-dots {
    display: flex;
    gap: 2px;
    margin-top: 4px;
}

.dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: #333;
}

.dot.active {
    background-color: #4CAF50;
}

.dot.medium {
    background-color: #FFA726;
}
</style>

<div id="confluenceWidget">
    <!-- Alert Banner (shown when new alerts exist) -->
    <div id="alertBanner" class="alert-banner" style="display: none;">
        <span style="margin-right: 10px;">ðŸ””</span>
        <span id="alertText">New confluence opportunities detected!</span>
    </div>

    <!-- Confluence Opportunities Section -->
    <div class="confluence-section">
        <div class="confluence-header">
            <span>ðŸŽ¯ CONFLUENCE OPPORTUNITIES (Hourly + Daily)</span>
            <small style="margin-left: auto; color: #888;">Updated: <span id="confluenceUpdateTime">--:--</span></small>
        </div>
        <div id="confluenceTickers" class="confluence-grid">
            <!-- Confluence tickers will be populated here -->
        </div>
    </div>

    <!-- Emerging Tickers Section -->
    <div class="confluence-section">
        <div class="confluence-header">
            <span>ðŸš€ EMERGING TICKERS (Strong Hourly, Pre-Daily)</span>
        </div>
        <div id="emergingTickers" class="confluence-grid">
            <!-- Emerging tickers will be populated here -->
        </div>
    </div>
</div>

<script>
// Confluence Widget JavaScript
(function() {
    let lastAlertCheck = null;
    
    // Function to fetch confluence data
    async function fetchConfluenceData() {
        try {
            const response = await fetch('/api/confluence-analysis');
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Error fetching confluence data:', error);
            // Fallback: try to read from static JSON file
            try {
                const response = await fetch('/analysis/hourly_daily_confluence.json');
                return await response.json();
            } catch (fallbackError) {
                console.error('Fallback fetch failed:', fallbackError);
                return null;
            }
        }
    }
    
    // Function to fetch alerts
    async function fetchAlerts() {
        try {
            const response = await fetch('/alerts/latest_confluence_alerts.json');
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Error fetching alerts:', error);
            return null;
        }
    }
    
    // Function to render confluence ticker
    function renderConfluenceTicker(ticker) {
        const scoreClass = ticker.confluence_score > 80 ? 'high' : 
                          ticker.confluence_score > 70 ? 'medium' : 'low';
        
        const signalClass = ticker.signal === 'STRONG' ? 'signal-strong' :
                           ticker.signal === 'MEDIUM' ? 'signal-medium' : 'signal-weak';
        
        return `
            <div class="confluence-ticker">
                <div class="confluence-ticker-header">
                    <span class="ticker-symbol">${ticker.ticker}</span>
                    <span class="confluence-score ${scoreClass}">${ticker.confluence_score.toFixed(0)}</span>
                </div>
                <div class="ticker-metrics">
                    <span>H: ${ticker.hourly_appearances} | D: ${ticker.daily_appearances}</span>
                    <span class="signal-badge ${signalClass}">${ticker.signal}</span>
                </div>
                <div class="ticker-metrics">
                    <span>Avg Momentum: ${((ticker.hourly_momentum_avg + ticker.daily_momentum_avg) / 2).toFixed(1)}%</span>
                </div>
                <div class="momentum-bar">
                    <div class="momentum-fill" style="width: ${Math.min(ticker.confluence_score, 100)}%"></div>
                </div>
                <div class="timeframe-dots">
                    ${renderDots(ticker.hourly_appearances, 5, 'Hourly')}
                    ${renderDots(ticker.daily_appearances, 10, 'Daily')}
                </div>
            </div>
        `;
    }
    
    // Function to render emerging ticker
    function renderEmergingTicker(ticker) {
        const potentialClass = ticker.potential === 'HIGH' ? 'high' : 'medium';
        
        return `
            <div class="confluence-ticker emerging-ticker">
                <div class="confluence-ticker-header">
                    <span class="ticker-symbol">${ticker.ticker}</span>
                    <span class="confluence-score ${potentialClass}">${ticker.hourly_strength.toFixed(0)}</span>
                </div>
                <div class="ticker-metrics">
                    <span>Hourly: ${ticker.hourly_appearances} appearances</span>
                    <span style="color: ${ticker.potential === 'HIGH' ? '#4CAF50' : '#FFA726'}">
                        ${ticker.potential}
                    </span>
                </div>
                <div class="ticker-metrics">
                    <span>Avg Momentum: ${ticker.hourly_momentum_avg.toFixed(1)}%</span>
                </div>
                <div class="momentum-bar">
                    <div class="momentum-fill" style="width: ${Math.min(ticker.hourly_strength, 100)}%; background: linear-gradient(90deg, #FF5722, #FF7043);"></div>
                </div>
            </div>
        `;
    }
    
    // Function to render dots for visual representation
    function renderDots(count, max, label) {
        const dots = [];
        const activeCount = Math.min(count, max);
        
        for (let i = 0; i < max; i++) {
            if (i < activeCount) {
                dots.push('<span class="dot active" title="' + label + '"></span>');
            } else {
                dots.push('<span class="dot" title="' + label + '"></span>');
            }
        }
        
        return dots.join('');
    }
    
    // Function to update the widget
    async function updateConfluenceWidget() {
        const data = await fetchConfluenceData();
        if (!data) return;
        
        // Update confluence tickers
        const confluenceContainer = document.getElementById('confluenceTickers');
        if (data.confluence_tickers && data.confluence_tickers.length > 0) {
            confluenceContainer.innerHTML = data.confluence_tickers
                .slice(0, 6) // Show top 6
                .map(ticker => renderConfluenceTicker(ticker))
                .join('');
        } else {
            confluenceContainer.innerHTML = '<p style="color: #888; text-align: center;">No confluence opportunities at this time</p>';
        }
        
        // Update emerging tickers
        const emergingContainer = document.getElementById('emergingTickers');
        if (data.emerging_tickers && data.emerging_tickers.length > 0) {
            emergingContainer.innerHTML = data.emerging_tickers
                .slice(0, 4) // Show top 4
                .map(ticker => renderEmergingTicker(ticker))
                .join('');
        } else {
            emergingContainer.innerHTML = '<p style="color: #888; text-align: center;">No emerging tickers at this time</p>';
        }
        
        // Update timestamp
        document.getElementById('confluenceUpdateTime').textContent = 
            new Date().toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
        
        // Check for new alerts
        const alerts = await fetchAlerts();
        if (alerts && alerts.active_count > 0) {
            const alertBanner = document.getElementById('alertBanner');
            const alertText = document.getElementById('alertText');
            
            if (alerts.alerts && alerts.alerts.length > 0) {
                const latestAlert = alerts.alerts[alerts.alerts.length - 1];
                alertText.textContent = latestAlert.message;
                alertBanner.style.display = 'flex';
                
                // Hide after 10 seconds
                setTimeout(() => {
                    alertBanner.style.display = 'none';
                }, 10000);
            }
        }
    }
    
    // Initial update
    updateConfluenceWidget();
    
    // Update every 60 seconds
    setInterval(updateConfluenceWidget, 60000);
    
    // Export for external use
    window.confluenceWidget = {
        update: updateConfluenceWidget,
        fetchData: fetchConfluenceData
    };
})();
</script>